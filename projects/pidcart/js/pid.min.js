let Mc=2;let Mp=1;let L=1;const G=9.81;const CRR=.001;const CD=1;let cartx=0;let cartv=0;let theta=10*Math.PI/180;let omega=0;const DT=.001;const FR=25;const LOOP=Math.max(1,Math.round(1/(FR*DT)));const SP=0;let Kp=200;let Ki=10*DT;let Kd=5/DT;const DIMX=window.innerWidth;const DIMY=window.innerHeight;const SCALE=200;let CARTH=Math.pow(Mc/1e3,1/3)*SCALE;let CARTW=CARTH*3;let PENDR=Math.pow(Mp/1e3,1/3)*SCALE;let minth=theta*180/Math.PI;let maxth=minth;let minx=cartx;let maxx=minx;let minU=0;let maxU=0;const HALFX=DIMX*.5;const HALFY=DIMY*.5;let WHEELB=(CARTW-CARTH)*.5;let WHEELR=CARTH*.5;let C1=Mp/(Mp+Mc);let C2=C1*G;let C3=C1/Mp;let C4=C3/L;let C5=G/L;let LP=L*SCALE;let U=0;let err_cur=0;let err_prv=0;let err_sum=0;let err_dif=0;let isDown=false;let slideTheta,slideProp,slideInt,slideDif,slideLen,slideMc,slideMp;function showVal(){document.getElementById("minth").innerHTML=minth;document.getElementById("maxth").innerHTML=maxth;document.getElementById("minx").innerHTML=minx;document.getElementById("maxx").innerHTML=maxx;document.getElementById("minU").innerHTML=minU;document.getElementById("maxU").innerHTML=maxU;document.getElementById("valTheta").innerHTML=round(theta*18e3/PI)/100;document.getElementById("valProp").innerHTML=round(slideProp.value()*100)/100;document.getElementById("valInt").innerHTML=round(slideInt.value()*100)/100;document.getElementById("valDif").innerHTML=round(slideDif.value()*100)/100;document.getElementById("valLen").innerHTML=round(slideLen.value()*100)/100;document.getElementById("valMc").innerHTML=round(slideMc.value()*100)/100;document.getElementById("valMp").innerHTML=round(slideMp.value()*100)/100}function zeroPID(){document.getElementById("demo").innerHTML="zero PID"}function reset(){theta=HALF_PI-slideTheta.value()*PI/180;Kp=slideProp.value();Ki=slideInt.value()*DT;Kd=slideDif.value()/DT;L=slideLen.value()/100;Mc=slideMc.value();Mp=slideMp.value();CARTH=Math.pow(Mc/1e3,1/3)*SCALE;CARTW=CARTH*3;PENDR=Math.pow(Mp/1e3,1/3)*SCALE;WHEELB=(CARTW-CARTH)*.5;WHEELR=CARTH*.5;C1=Mp/(Mp+Mc);C2=C1*G;C3=C1/Mp;C4=C3/L;C5=G/L;LP=L*SCALE;cartv=0;cartx=0;omega=0;minth=round(theta*180/PI);maxth=minth;minx=round(cartx*100);maxx=minx;minU=0;maxU=0;err_prv=0;err_sum=0;isDown=false;showVal()}function btnZeroPID(){slideProp.value(0);slideInt.value(0);slideDif.value(0);reset()}function btnResetAll(){slideTheta.value(90-10);slideProp.value(200);slideInt.value(10);slideDif.value(5);slideLen.value(100);slideMc.value(2);slideMp.value(1);reset()}function setup(){const cnv=createCanvas(DIMX,DIMY);cnv.parent("sketch");strokeWeight(2);stroke(255);noFill();rectMode(CENTER);ellipseMode(RADIUS);frameRate(FR);slideTheta=createSlider(0,180,(HALF_PI-theta)*180/PI,1);slideProp=createSlider(0,2e3,Kp,2);slideInt=createSlider(0,1e3,Ki/DT,1);slideDif=createSlider(0,1e3,Kd*DT,1);slideLen=createSlider(1,200,L*100,1);slideMc=createSlider(.01,10,Mc,.01);slideMp=createSlider(.01,10,Mp,.01);slideTheta.parent("cntTheta");slideProp.parent("cntProp");slideInt.parent("cntInt");slideDif.parent("cntDif");slideLen.parent("cntLen");slideMc.parent("cntMc");slideMp.parent("cntMp");slideTheta.style("width","600px");slideProp.style("width","600px");slideInt.style("width","600px");slideDif.style("width","600px");slideLen.style("width","600px");slideMc.style("width","600px");slideMp.style("width","600px");slideTheta.changed(reset);slideProp.changed(reset);slideInt.changed(reset);slideDif.changed(reset);slideLen.changed(reset);slideMc.changed(reset);slideMp.changed(reset);showVal()}function draw(){let cost,sint;for(let dummy=0;dummy<LOOP;++dummy){err_cur=SP-theta;if(Math.abs(err_cur)<HALF_PI){if(isDown){isDown=false;err_sum=0;err_prv=0}err_sum+=err_cur;err_dif=err_cur-err_prv;err_prv=err_cur;U=Kp*err_cur+Ki*err_sum+Kd*err_dif}else{isDown=true;U=0}cost=cos(theta);sint=sin(theta);const det=1-C1*cost*cost;const W2=C1*omega*omega*sint;const carta=(C2*sint*cost-L*W2+C3*U)/det;const penda=(C5*sint-W2*cost+C4*U*cost)/det;cartv+=carta*DT;cartx+=cartv*DT;omega+=penda*DT;theta+=omega*DT;if(theta>PI){theta-=TWO_PI}if(theta<=-PI){theta+=TWO_PI}const curth=round(theta*180/PI);const curx=round(cartx*100);const curU=round(U);document.getElementById("curth").innerHTML=curth;document.getElementById("curx").innerHTML=curx;document.getElementById("curU").innerHTML=curU;if(curth<minth){minth=curth;document.getElementById("minth").innerHTML=curth}if(curth>maxth){maxth=curth;document.getElementById("maxth").innerHTML=curth}if(curx<minx){minx=curx;document.getElementById("minx").innerHTML=curx}if(curx>maxx){maxx=curx;document.getElementById("maxx").innerHTML=curx}if(curU<minU){minU=U;document.getElementById("minU").innerHTML=curU}if(curU>maxU){maxU=U;document.getElementById("maxU").innerHTML=curU}}translate(HALFX,HALFY);scale(1,-1);background(0);line(-HALFX,0,HALFX,0);stroke(255,255,255,102);line(0,-HALFY,0,HALFY);const pminx=minx*.01*SCALE-CARTW*.5;const pmaxx=maxx*.01*SCALE+CARTW*.5;stroke(255,255,51);line(pminx,0,pminx,WHEELR+CARTH);line(pmaxx,0,pmaxx,WHEELR+CARTH);stroke(255);push();translate(cartx*SCALE,CARTH);fill(102,153,255,153);rect(0,0,CARTW,CARTH);fill(102,153,255,153);arc(-WHEELB,-WHEELR,WHEELR,WHEELR,PI,0);arc(WHEELB,-WHEELR,WHEELR,WHEELR,PI,0);const px=-sint*LP;const py=cost*LP;fill(255,102,153,153);circle(px,py,PENDR);line(0,0,px,py);pop()}